from zeep import Client
from zeep.transports import Transport
from requests_ntlm import HttpNtlmAuth
import requests

# === Config ===
report_path = "/MyFolder/MyReport"
username = "DOMAIN\\your.username"
password = "your_password"
soap_wsdl = "https://reportingsitesrv.hbeu.adroot.hsbc:8080/ReportServer_SSRS/ReportExecution2005.asmx?wsdl"

# === Setup NTLM Session ===
session = requests.Session()
session.auth = HttpNtlmAuth(username, password)
session.verify = False
transport = Transport(session=session)

# === Create SOAP client ===
client = Client(wsdl=soap_wsdl, transport=transport)

try:
    # Get the proper ParameterValue type
    ParameterValue = client.get_type('ns0:ParameterValue')
    
    # === Load Report ===
    exec_info = client.service.LoadReport(Report=report_path, HistoryID=None)
    execution_id = exec_info.ExecutionID
    
    # === Set Parameters - PROPER STRUCTURE ===
    parameters = [
        ParameterValue(
            Name='Machine', 
            Value='YOUR_MACHINE_NAME',  # Replace with actual value
            Label='Machine'  # Optional but recommended
        ),
        ParameterValue(
            Name='AuthListID', 
            Value='ScopeId_6D845B66-152B-4C86-8ABF-3848BA17BDD9/AuthList_22a24e7e-6da4-4a5b-ab17-e8054da41b82',
            Label='AuthListID'  # Optional but recommended
        )
    ]
    
    # Set parameters with execution context
    client.service.SetExecutionParameters(
        ExecutionID=execution_id,
        Parameters=parameters,
        ParameterLanguage='en-us'
    )
    
    # === Render Report ===
    render_response = client.service.Render(
        ExecutionID=execution_id,
        Format='CSV',
        DeviceInfo='',
        Extension='',
        StreamId=''
    )
    
    # === Save Output ===
    with open("report.csv", "wb") as file:
        file.write(render_response.Result)
    
    print("✅ Report successfully generated as 'report.csv'")

except Exception as e:
    print(f"❌ Error: {str(e)}")
    if hasattr(e, 'detail'):
        from zeep.helpers import serialize_object
        print("Details:", serialize_object(e.detail))
