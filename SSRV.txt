from zeep import Client
from zeep.transports import Transport
from zeep.plugins import HistoryPlugin
from requests import Session
from requests_kerberos import HTTPKerberosAuth
from lxml import etree

# === Setup session and transport ===
session = Session()
session.auth = HTTPKerberosAuth(mutual_authentication='OPTIONAL')
session.verify = False
transport = Transport(session=session)

# === Setup history plugin to capture raw SOAP ===
history = HistoryPlugin()

# === WSDL URL ===
wsdl_url = 'http://reportingsitesrv.hbeu.adroot.hsbc/ReportServer_SSRS/ReportExecution2005.asmx?wsdl'

# === Create SOAP client ===
client = Client(wsdl=wsdl_url, transport=transport, plugins=[history])

# === Load the report ===
report_path = '/Your/Report/Path/Here'
exec_info = client.service.LoadReport(Report=report_path, HistoryID=None)
execution_id = exec_info.ExecutionID

# === Set ExecutionHeader ===
execution_header_type = client.get_type('ns0:ExecutionHeader')
execution_header = execution_header_type(ExecutionID=execution_id)
client.set_default_soapheaders([execution_header])

# === Get parameter type ===
ParameterValue = client.get_type('ns0:ParameterValue')

# === Define parameters (without Label) ===
parameters = [
    ParameterValue(Name='Machine', Value='ZAW25104285'),
    ParameterValue(Name='AuthListID', Value='ScopeId_6D845B66-152B-4C86-8ABF-3848BA17BDD9/AuthList_22a24e7e-6da4-4a5b-ab17-e8054da41b82')
]

# === Set parameters ===
client.service.SetExecutionParameters(Parameters=parameters, ParameterLanguage='en-us')

# === Log raw SOAP request and response ===
print("\n=== RAW SOAP REQUEST ===")
print(etree.tostring(history.last_sent.envelope, pretty_print=True).decode())

print("\n=== RAW SOAP RESPONSE ===")
print(etree.tostring(history.last_received.envelope, pretty_print=True).decode())

# === Render report ===
result = client.service.Render(Format='CSV', DeviceInfo='')
with open('report.csv', 'wb') as f:
    f.write(result['Result'])

print("âœ… Report generated as 'report.csv'")
