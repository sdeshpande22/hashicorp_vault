from zeep import Client
from zeep.transports import Transport
from requests_ntlm import HttpNtlmAuth
import requests

# === Config ===
report_path = "/MyFolder/MyReport"  # Replace this with your actual report path
username = "DOMAIN\\your.username"  # Replace with your NTLM domain + username
password = "your_password"
soap_wsdl = "https://reportingsitesrv.hbeu.adroot.hsbc/ReportServer_SSRS/ReportExecution2005.asmx?wsdl"

# === Setup NTLM Session ===
session = requests.Session()
session.auth = HttpNtlmAuth(username, password)
transport = Transport(session=session)

# === Create SOAP client ===
client = Client(wsdl=soap_wsdl, transport=transport)
service = client.service

# === Load Report ===
exec_info = service.LoadReport(Report=report_path, HistoryID=None)
execution_id = exec_info.ExecutionID

# === Set Parameters ===
parameters = [
    {'Name': 'Machine', 'Value': 'MY_MACHINE_NAME'},  # Replace with actual machine name
    {'Name': 'AuthListID', 'Value': 'ScopeId_6D845B66-152B-4C86-8ABF-3848BA17BDD9/AuthList_22a24e7e-6da4-4a5b-ab17-e8054da41b82'}
]
service.SetExecutionParameters(Parameters=parameters, ParameterLanguage='en-us')

# === Render the Report in CSV format ===
result = service.Render(Format='CSV', DeviceInfo=None)

# === Save the CSV result ===
with open("report.csv", "wb") as file:
    file.write(result['Result'])

print("âœ… Report saved as 'report.csv'")
